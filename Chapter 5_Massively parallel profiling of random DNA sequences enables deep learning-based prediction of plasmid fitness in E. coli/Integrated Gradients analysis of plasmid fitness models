"""
Run Integrated Gradients (IG) on a trained CNN model to identify
sequence regions and k-mers that contribute most strongly to predicted fitness.
"""

import os
import numpy as np
import torch
from captum.attr import IntegratedGradients
from tqdm import tqdm

# Config
DEVICE = torch.device("cuda" if torch.cuda.is_available() else "cpu")
SEQ_LEN = 192
ALPHABET = ["A", "C", "G", "T"]

# Load model
def load_model(model_cls, checkpoint_path):
    model = model_cls()
    model.load_state_dict(torch.load(checkpoint_path, map_location=DEVICE))
    model.to(DEVICE)
    model.eval()
    return model

# Run IG
def run_integrated_gradients(model, sequences, batch_size=64, n_steps=10):
    """
    sequences: (N, 192, 4) numpy array
    returns:   (N, 192) summed IG attribution per position
    """
    ig = IntegratedGradients(model)
    baseline = torch.zeros((1, SEQ_LEN, 4), device=DEVICE)

    seq_tensor = torch.tensor(sequences, dtype=torch.float32, device=DEVICE)
    N = seq_tensor.shape[0]
    attributions = np.zeros((N, SEQ_LEN), dtype=np.float32)

    for i in tqdm(range(0, N, batch_size), desc="Integrated Gradients"):
        batch = seq_tensor[i:i+batch_size]
        bsz = batch.shape[0]
        base = baseline.repeat(bsz, 1, 1)

        attr = ig.attribute(
            batch,
            baselines=base,
            n_steps=n_steps,
            internal_batch_size=bsz
        )

        attr_sum = attr.sum(dim=2).detach().cpu().numpy()
        attributions[i:i+batch_size] = attr_sum

    return attributions

# k-mer extraction
def extract_kmers(seqs, attr, k=6):
    """
    Extract k-mers centred on the max-attribution position.
    """
    half = k // 2
    kmers = []

    for s, a in zip(seqs, attr):
        idx = int(np.argmax(a))
        start = max(0, idx - half)
        end   = start + k
        if end <= len(s):
            kmers.append(s[start:end])

    return kmers


if __name__ == "__main__":
    raise RuntimeError(
        "This script expects:\n"
        "  - A trained model checkpoint\n"
        "  - One-hot encoded sequences (N×192×4)\n"
        "Provide these via a wrapper script in reproducibility/."
    )
